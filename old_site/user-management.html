<!DOCTYPE html>
<html>
<head>
  <title>User Management</title>
  <style>
    label { display: block; margin-top: 8px; }
    input, select { width: 300px; }
    .user-card { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
  </style>
</head>
<body>
  <h1>User Management</h1>

  <form id="userForm">
    <label>First Name: <input name="first_name" required></label>
    <label>Last Name: <input name="last_name" required></label>
    <label>Guardian Name: <input name="guardian_name"></label>
    <label>Guardian Email: <input name="guardian_email"></label>
    <label>Guardian Cell: <input name="guardian_cell"></label>
    <label>User Email: <input name="user_email"></label>
    <label>User Cell: <input name="user_cell"></label>
    <label>Is Active:
      <select name="is_active">
        <option value="true" selected>Yes</option>
        <option value="false">No</option>
      </select>
    </label>
    <label>Group Assignments (hold CTRL to select multiple):
      <select name="groups" multiple>
        <option>deacon</option>
        <option>teacher</option>
        <option>priest</option>
        <option>young man</option>
        <option>young women (younger)</option>
        <option>young women (older)</option>
        <option>young women</option>
      </select>
    </label>
    <button type="submit">Save User</button>
  </form>

  <h2>All Users</h2>
  <div id="usersContainer"></div>

  <script>
    const base_url = window.env?.BASE_URL || 'http://localhost:8000';

    async function loadUsers() {
      const res = await fetch(`${base_url}/users`);
      const users = await res.json();
      const container = document.getElementById("usersContainer");
      container.innerHTML = '';
      users.forEach(user => {
        const div = document.createElement("div");
        div.className = "user-card";
        div.innerHTML = `<b>${user.first_name} ${user.last_name}</b><br>
        Guardian: ${user.guardian_name} (${user.guardian_email})<br>
        Groups: ${user.groups.join(", ")}<br>
        Active: ${user.is_active ? "Yes" : "No"}`;
        container.appendChild(div);
      });
    }

    document.getElementById("userForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const payload = {
        first_name: formData.get("first_name"),
        last_name: formData.get("last_name"),
        guardian_name: formData.get("guardian_name"),
        guardian_email: formData.get("guardian_email"),
        guardian_cell: formData.get("guardian_cell"),
        user_email: formData.get("user_email"),
        user_cell: formData.get("user_cell"),
        is_active: formData.get("is_active") === "true",
        groups: Array.from(form.querySelector("select[name='groups']").selectedOptions).map(opt => opt.value)
      };
      await fetch(`${base_url}/users`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      form.reset();
      loadUsers();
    });

    loadUsers();
  </script>
</body>
</html>
