<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parental Permission</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">Permission Waiver</h2>

    <div id="contentSection" class="card p-4 shadow-sm" style="display: none;">
      <p><strong>Participant:</strong> <span id="userName"></span></p>
      <p><strong>Activity:</strong> <span id="activityName"></span></p>
      <p><strong>Dates:</strong> <span id="activityDates"></span></p>
      <p><strong>Description:</strong></p>
      <p id="activityDescription" class="border p-2 bg-light"></p>

      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" value="" id="confirmCheck" />
        <label class="form-check-label" for="confirmCheck">
          I confirm that I am the guardian and grant permission for this activity.
        </label>
      </div>

      <button id="submitBtn" class="btn btn-primary mt-3" disabled>Sign Permission</button>
    </div>

    <div id="loading" class="text-muted">Loading...</div>
    <div id="error" class="alert alert-danger mt-3 d-none"></div>
    <div id="success" class="alert alert-success mt-3 d-none">
      ✅ Thank you! Permission has been recorded.
    </div>
  </div>

  <script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  if (!token) {
    // No token → use local fallback
    fetch("test_data/parental-activity-examples.json")
      .then(res => {
        if (!res.ok) throw new Error("Failed to load fallback data");
        return res.json();
      })
      .then(data => {
        const fallback = data[0]; // assume using the first entry in the array
        document.getElementById("loading").style.display = "none";
        document.getElementById("contentSection").style.display = "block";

        document.getElementById("userName").textContent = fallback.user_name;
        document.getElementById("activityName").textContent = fallback.activity_name;
        document.getElementById("activityDates").textContent =
          new Date(fallback.date_start).toLocaleDateString() + " to " +
          new Date(fallback.date_end).toLocaleDateString();
        document.getElementById("activityDescription").textContent = fallback.description;
      })
      .catch(err => {
        showError("Could not load example activity data.");
      });
  } else {
    // Token present → verify with API
    fetch(`/api/verify-token?token=${token}`)
      .then(res => {
        if (!res.ok) throw new Error("Token invalid or expired");
        return res.json();
      })
      .then(data => {
        document.getElementById("loading").style.display = "none";
        document.getElementById("contentSection").style.display = "block";

        document.getElementById("userName").textContent = data.user_name;
        document.getElementById("activityName").textContent = data.activity_name;
        document.getElementById("activityDates").textContent =
          new Date(data.date_start).toLocaleDateString() + " to " +
          new Date(data.date_end).toLocaleDateString();
        document.getElementById("activityDescription").textContent = data.description;
      })
      .catch(err => {
        showError("This permission link is invalid or has expired.");
      });
  }

  function showError(msg) {
    document.getElementById("loading").style.display = "none";
    const err = document.getElementById("error");
    err.classList.remove("d-none");
    err.textContent = msg;
  }

  document.getElementById("confirmCheck").addEventListener("change", (e) => {
    document.getElementById("submitBtn").disabled = !e.target.checked;
  });

  document.getElementById("submitBtn").addEventListener("click", async () => {
    if (!token) {
      alert("Test mode only — submission not available without a token.");
      return;
    }

    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.textContent = "Submitting...";

    const res = await fetch("/api/submit-permission", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token })
    });

    if (res.ok) {
      document.getElementById("contentSection").style.display = "none";
      document.getElementById("success").classList.remove("d-none");
    } else {
      showError("Failed to submit permission. Please try again.");
    }
  });
</script>

</body>
</html>
