<!DOCTYPE html>
<html>
<head>
  <title>User Management</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
  <div class="container py-5">
    <!-- Login Section -->
    <div id="loginSection" class="card p-4 shadow-sm" style="max-width: 400px; margin: auto;">
      <h3 class="mb-3">Login</h3>
      <form id="loginForm">
        <div class="mb-3">
          <label class="form-label">User Email</label>
          <input name="email" type="email" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input name="password" type="password" class="form-control" required>
        </div>
        <button class="btn btn-primary w-100">Log In</button>
      </form>
      <div id="loginError" class="text-danger mt-3" style="display: none;"></div>
    </div>

    <!-- User Management Section -->
    <div id="userMgmtSection" style="display: none;">
      <h1 class="mb-4">User Management</h1>

      <form id="userForm" class="mb-5 bg-white p-4 border rounded shadow-sm">
        <div class="row g-3">
          <!-- Form fields (same as before) -->
          <!-- ... include first_name, last_name, guardian info, etc. ... -->
          <div class="col-md-6">
            <label class="form-label">First Name</label>
            <input name="first_name" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Last Name</label>
            <input name="last_name" class="form-control" required>
          </div>
          <!-- Add the rest of the fields here just like earlier -->
          <div class="col-12">
            <label class="form-label">Password (for this user)</label>
            <input name="password" class="form-control" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary mt-4">Save User</button>
      </form>

      <h2>All Users</h2>
      <div id="usersContainer" class="mt-3"></div>
    </div>
  </div>

 <script>
  const BASE_URL = "/api";
  const token = localStorage.getItem("token");

  const loginSection = document.getElementById("loginSection");
  const userMgmtSection = document.getElementById("userMgmtSection");
  const loginForm = document.getElementById("loginForm");
  const loginError = document.getElementById("loginError");

  const TEST_EMAIL = "tester@test.com";
  const TEST_PASSWORD = "local";
  const TEST_TOKEN = "test-token";

  // If a token is already set, try to load users
  if (token) {
    loginSection.style.display = "none";
    userMgmtSection.style.display = "block";
    loadUsers();
  }

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = new FormData(loginForm);
    const email = form.get("email");
    const password = form.get("password");

    // Handle test account
    if (email === TEST_EMAIL && password === TEST_PASSWORD) {
      localStorage.setItem("token", TEST_TOKEN);
      loginSection.style.display = "none";
      userMgmtSection.style.display = "block";
      loadUsers(true); // pass true for test mode
      return;
    }

    // Real login
    const res = await fetch(`${BASE_URL}/login`, {
      method: "POST",
      body: new URLSearchParams({
        user_email: email,
        password: password
      })
    });

    const data = await res.json();
    if (res.ok) {
      localStorage.setItem("token", data.access_token);
      loginSection.style.display = "none";
      userMgmtSection.style.display = "block";
      loadUsers();
    } else {
      loginError.style.display = "block";
      loginError.textContent = data.detail || "Login failed";
    }
  });

  async function loadUsers(useTestData = false) {
    const container = document.getElementById("usersContainer");
    container.innerHTML = "";

    let users;

    try {
      if (useTestData || localStorage.getItem("token") === TEST_TOKEN) {
        const res = await fetch("user-examples.json");
        if (!res.ok) throw new Error("Failed to load test data");
        users = await res.json();
      } else {
        const res = await fetch(`${BASE_URL}/users`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
        });
        if (res.status === 401) return logout();
        users = await res.json();
      }

      users.forEach(user => {
        const div = document.createElement("div");
        div.className = "card p-3 mb-3";
        div.innerHTML = `<b>${user.first_name} ${user.last_name}</b><br>
          Guardian: ${user.guardian_name} (${user.guardian_email})<br>
          Groups: ${user.groups.join(", ")}<br>
          Active: ${user.is_active ? "Yes" : "No"}`;
        container.appendChild(div);
      });

    } catch (err) {
      container.innerHTML = `<div class="text-danger">Failed to load users: ${err.message}</div>`;
    }
  }

  document.getElementById("userForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (localStorage.getItem("token") === TEST_TOKEN) {
      alert("Test mode: user creation disabled.");
      return;
    }

    const form = e.target;
    const formData = new FormData(form);
    const payload = {
      first_name: formData.get("first_name"),
      last_name: formData.get("last_name"),
      guardian_name: formData.get("guardian_name"),
      guardian_email: formData.get("guardian_email"),
      guardian_cell: formData.get("guardian_cell"),
      user_email: formData.get("user_email"),
      user_cell: formData.get("user_cell"),
      is_active: formData.get("is_active") === "true",
      groups: Array.from(form.querySelector("select[name='groups']").selectedOptions).map(opt => opt.value),
      password: formData.get("password")
    };

    const res = await fetch(`${BASE_URL}/users`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("token")}`
      },
      body: JSON.stringify(payload)
    });

    if (res.status === 401) return logout();
    form.reset();
    loadUsers();
  });

  function logout() {
    localStorage.removeItem("token");
    location.reload();
  }
</script>
</body>
</html>
