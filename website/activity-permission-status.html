<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Permission Status</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .checkmark { color: green; font-size: 1.5rem; }
    .crossmark { color: red; font-size: 1.5rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">Activity Permission Status</h2>

    <div id="permissionSection" style="display: none;">
    <table class="table table-hover bg-white shadow-sm">
        <thead class="table-light">
            <tr>
            <th>User</th>
            <th>Guardian Name</th>
            <th>Signed?</th>
            <th>Last Request</th>
            <th>Actions</th>
            </tr>
        </thead>
        <tbody id="permissionTableBody">
            <!-- JS-generated -->
        </tbody>
    </table>
    <button class="btn btn-warning mt-3" id="reRequestBtn">Re-request All Unsigned</button>
    </div>

    <div id="loading" class="text-muted">Loading...</div>
    <div id="error" class="text-danger" style="display:none;">Failed to load permission data.</div>
  </div>

  <script>
  const token = localStorage.getItem("token");
  const params = new URLSearchParams(window.location.search);
  const activityId = params.get("id");

  const ONE_DAY = 24 * 60 * 60 * 1000;
  let permissionData = [];

  async function loadPermissions() {
    if (!activityId) return showError("Missing activity ID");

    try {
      const res = await fetch(`/api/activity-permissions?id=${activityId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) throw new Error("Fetch failed");
      permissionData = await res.json();

      document.getElementById("loading").style.display = "none";
      document.getElementById("permissionSection").style.display = "block";

      renderPermissions();

      // Disable re-request if within 24 hrs
      const recent = permissionData.some(p => p.last_requested_at && Date.now() - new Date(p.last_requested_at).getTime() < ONE_DAY);
      document.getElementById("reRequestBtn").disabled = recent;

    } catch (e) {
      console.error(e);
      showError("Failed to load permission data.");
    }
  }

  function showError(msg) {
    document.getElementById("loading").style.display = "none";
    const error = document.getElementById("error");
    error.innerText = msg;
    error.style.display = "block";
  }

  function renderPermissions() {
    const tbody = document.getElementById("permissionTableBody");
    tbody.innerHTML = "";

    permissionData.forEach(user => {
      const last = user.last_requested_at ? new Date(user.last_requested_at).toLocaleString() : "—";
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${user.user_name}</td>
        <td>${user.guardian_name || "—"}</td>
        <td class="text-center">
          ${user.signed ? '<span class="checkmark">✔️</span>' : '<span class="crossmark">❌</span>'}
        </td>
        <td>${last}</td>
        <td>
          ${!user.signed
            ? `<button class="btn btn-sm btn-outline-primary" onclick="resendOne(${user.permission_id})">Resend</button>`
            : `<span class="text-muted">Signed</span>`}
        </td>
      `;

      tbody.appendChild(row);
    });
  }

  async function resendOne(permissionId) {
    const res = await fetch(`/api/resend-permission?id=${permissionId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (res.ok) {
      alert("Resent waiver to guardian.");
      loadPermissions();
    } else {
      alert("Failed to resend.");
    }
  }

  document.getElementById("reRequestBtn").addEventListener("click", async () => {
    if (!confirm("Re-send waivers to all unsigned guardians?")) return;
    const res = await fetch(`/api/request-permissions?id=${activityId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (res.ok) {
      alert("Requests resent.");
      loadPermissions();
    } else {
      alert("Request failed.");
    }
  });

  loadPermissions();
</script>
</body>
</html>
