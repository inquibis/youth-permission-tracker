# Use an official Python base image
FROM python:3.11-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV BASE_URL=http://localhost:8000
ENV MYSQL_USER=""
ENV MYSQL_PASSWORD=""
ENV MYSQL_HOST=mysql
ENV MYSQL_PORT=3306
ENV MYSQL_DB=activitydb
ENV BASE_URL=http://localhost/api
# ENV DATABASE_URL=mysql+pymysql://user:password@mysql/db_name

# Set work directory
WORKDIR /app

# Install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Generate test SSL keys for signing
RUN mkdir -p certs && \
    openssl req -x509 -nodes -newkey rsa:2048 \
    -keyout certs/server_key.pem -out certs/server_cert.pem \
    -subj "/C=US/ST=State/L=City/O=Org/OU=Dev/CN=localhost" -days 365

# Copy app files
COPY api/ /app/

# Expose port
EXPOSE 8000

# Entrypoint
#CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]

# Make sure alembic is installed
RUN alembic --version
RUN RUN alembic upgrade head

COPY migrate.sh /migrate.sh
RUN chmod +x /migrate.sh
CMD [\"./migrate.sh\"]