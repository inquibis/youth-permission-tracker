version: '3'

services:
  mysql-db:
    image: mysql:8.0
    container_name: mysql-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: myrootpass
      MYSQL_DATABASE: mystuff
      MYSQL_USER: appuser
      MYSQL_PASSWORD: appuserpass
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - backend
  mysql-backup:
    image: mysql:8.0
    container_name: mysql-backup
    restart: always
    volumes:
      - ./backups:/backups   # store dumps in ./backups folder
    depends_on:
      - mysql-db
    entrypoint: >
      sh -c "mkdir -p /backups &&
             while true; do
               mysqldump -h mysql-db -uappuser -pappuserpass mystuff > /backups/mystuff-$(date +%F-%H-%M).sql;
               sleep 86400;
             done"
    networks:
      - backend

volumes:
  mysql_data:   # persistent named volume

networks:
  backend:
    name: backend

# to restore db from backup
# docker exec -i mysql-db mysql -uappuser -pappuserpass mystuff < backups/mystuff-2025-07-29-00-00.sql
