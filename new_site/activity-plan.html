<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Activity</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;max-width:900px;margin:auto}
    label{display:block;margin-top:12px;font-weight:600}
    input,select,textarea{width:100%;padding:8px;margin-top:6px;box-sizing:border-box}
    .row{display:flex;gap:12px}
    .col{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #ccc;padding:6px;text-align:left}
    .small{width:auto;padding:6px 10px}
    .inline{display:inline-block}
    .muted{color:#666;font-size:90%}
    .success{color:green;margin-top:12px}
    .error{color:red;margin-top:12px}
  </style>
</head>
<body>
  <h1>Create / Edit Activity</h1>

  <div style="margin-bottom:12px">
    <label>Load activity by ID</label>
    <div class="row">
      <input type="text" id="load_activity_id" placeholder="activity_id" />
      <button id="loadBtn" class="small">Load</button>
      <button id="clearBtn" class="small">Clear</button>
    </div>
    <div id="load_status" class="muted"></div>
  </div>

  <form id="activityForm">
    <label>Activity Name <input type="text" id="activity_name" required></label>
    <label>Description <textarea id="description"></textarea></label>
    <div class="row">
      <div class="col"><label>Start Date <input type="datetime-local" id="date_start"></label></div>
      <div class="col"><label>End Date <input type="datetime-local" id="date_end"></label></div>
    </div>
    <label>Purpose <input type="text" id="purpose"></label>

    <h3>Budget</h3>
    <div class="row">
      <input type="text" id="budget_item" placeholder="Item" />
      <input type="number" id="budget_amount" placeholder="Amount" step="0.01" />
      <button type="button" id="addBudget" class="small">Add</button>
    </div>
    <table id="budgetTable">
      <thead><tr><th>Item</th><th>Amount</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <h3>Drivers</h3>
    <div class="row">
      <input type="text" id="driver_input" placeholder="Driver name" />
      <button type="button" id="addDriverBtn" class="small">Add</button>
    </div>
    <div id="drivers_list" class="muted"></div>

    <h3>Groups</h3>
    <label>Select Group(s)
      <select id="groups_select" multiple>
        <option value="Deacons">Deacons</option>
        <option value="Teachers">Teachers</option>
        <option value="Priests">Priests</option>
        <option value="Younger Young Women">Younger Young Women</option>
        <option value="Older Young Women">Older Young Women</option>
      </select>
    </label>
    <div id="groups_list" class="muted"></div>

    <div style="margin-top:16px">
      <button type="submit">Create</button>
      <button type="button" id="updateBtn">Update (PUT)</button>
    </div>

    <div id="status"></div>
  </form>

<script>
(() => {
  const budget = [];
  const drivers = [];
  const groups = [];
  let loadedActivityId = null;

  const budgetTableBody = document.querySelector('#budgetTable tbody');
  const driversList = document.getElementById('drivers_list');
  const groupsList = document.getElementById('groups_list');
  const status = document.getElementById('status');
  const loadStatus = document.getElementById('load_status');

  function renderBudget(){
    budgetTableBody.innerHTML = '';
    budget.forEach((b,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(b.item)}</td><td>${Number(b.amount).toFixed(2)}</td><td><button data-i="${i}" class="small removeBudget">Remove</button></td>`;
      budgetTableBody.appendChild(tr);
    });
  }

  function renderLists(){
    driversList.textContent = drivers.join(', ');
    groupsList.textContent = groups.join(', ');
  }

  function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  document.getElementById('addBudget').addEventListener('click', ()=>{
    const item = document.getElementById('budget_item').value.trim();
    const amount = document.getElementById('budget_amount').value;
    if(!item || amount === '') return;
    budget.push({item, amount: parseFloat(amount)});
    document.getElementById('budget_item').value = '';
    document.getElementById('budget_amount').value = '';
    renderBudget();
  });

  budgetTableBody.addEventListener('click', (e)=>{
    if(e.target.classList.contains('removeBudget')){
      const i = Number(e.target.dataset.i);
      budget.splice(i,1);
      renderBudget();
    }
  });

  document.getElementById('addDriverBtn').addEventListener('click', ()=>{
    const v = document.getElementById('driver_input').value.trim();
    if(!v) return;
    drivers.push(v);
    document.getElementById('driver_input').value = '';
    renderLists();
  });
  
  document.getElementById('groups_select').addEventListener('change', ()=>{
    const selectElement = document.getElementById('groups_select');
    groups.length = 0;
    for(const option of selectElement.selectedOptions){
      groups.push(option.value);
    }
    renderLists();
  });

  document.getElementById('activityForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    status.textContent=''; status.className='';
    const payload = collectPayload();
    try{
      const res = await fetch('/activities', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if(res.ok){
        const body = await res.json();
        status.textContent = 'Created activity: ' + (body.activity_id || 'ok'); status.className='success';
        loadedActivityId = body.activity_id || null;
      }else{
        const t = await res.text(); throw new Error(res.status+': '+t);
      }
    }catch(err){ status.textContent = 'Error: '+err.message; status.className='error'; }
  });

  document.getElementById('updateBtn').addEventListener('click', async ()=>{
    if(!loadedActivityId){ status.textContent = 'Load an activity first to update.'; status.className='error'; return; }
    const payload = collectPayload();
    try{
      const res = await fetch('/activities/'+encodeURIComponent(loadedActivityId), {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if(res.ok){ status.textContent = 'Updated.'; status.className='success'; }
      else { const t = await res.text(); throw new Error(res.status+': '+t); }
    }catch(err){ status.textContent = 'Error: '+err.message; status.className='error'; }
  });

  function collectPayload(){
    return {
      activity_name: document.getElementById('activity_name').value.trim(),
      description: document.getElementById('description').value.trim(),
      date_start: document.getElementById('date_start').value || null,
      date_end: document.getElementById('date_end').value || null,
      purpose: document.getElementById('purpose').value || null,
      budgets: budget,
      drivers: drivers,
      groups: groups
    };
  }

  document.getElementById('loadBtn').addEventListener('click', async ()=>{
    const id = document.getElementById('load_activity_id').value.trim();
    if(!id) return;
    loadStatus.textContent = 'Loading...'; loadStatus.className='muted';
    try{
      const res = await fetch('/activities/'+encodeURIComponent(id));
      if(!res.ok){ const t = await res.text(); throw new Error(res.status+': '+t); }
      const body = await res.json();
      // Try to find stored JSON in body.data or return body directly
      let data = body;
      if(body.data) data = (typeof body.data === 'string') ? JSON.parse(body.data) : body.data;

      populateForm(data);
      loadedActivityId = id;
      loadStatus.textContent = 'Loaded: ' + id;
    }catch(err){ loadStatus.textContent = 'Error: '+err.message; }
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    resetForm();
  });

  function populateForm(data){
    document.getElementById('activity_name').value = data.activity_name || data.name || '';
    document.getElementById('description').value = data.description || '';
    if(data.date_start) document.getElementById('date_start').value = data.date_start;
    if(data.date_end) document.getElementById('date_end').value = data.date_end;
    document.getElementById('purpose').value = data.purpose || '';

    budget.length = 0;
    if(Array.isArray(data.budgets)){
      for(const b of data.budgets) budget.push(typeof b === 'string' ? {item:b,amount:0} : b);
    }

    drivers.length = 0;
    if(Array.isArray(data.drivers)) for(const d of data.drivers) drivers.push(d);

    groups.length = 0;
    if(Array.isArray(data.groups)) for(const g of data.groups) groups.push(g);

    renderBudget(); renderLists();
  }

  function resetForm(){
    document.getElementById('activityForm').reset();
    budget.length = 0; drivers.length = 0; groups.length = 0; loadedActivityId = null; renderBudget(); renderLists(); status.textContent=''; loadStatus.textContent='';
  }

})();
</script>
</body>
</html>