<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Youth Permission Submission</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;max-width:900px;margin:auto}
    label{display:block;margin-top:12px;font-weight:600}
    input,select,textarea{width:100%;padding:8px;margin-top:6px;box-sizing:border-box}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .signature-box{border:1px solid #ccc;padding:8px;margin-top:8px}
    canvas{background:#fff;border:1px solid #888;width:100%;height:200px;touch-action:none}
    button{margin-top:12px;padding:10px 14px}
    .small{width:auto;padding:6px 10px}
    .success{color:green;margin-top:12px}
    .error{color:red;margin-top:12px}
  </style>
</head>
<body>
  <h1>Youth Permission Submission</h1>

  <form id="permissionForm">
    Create a 6 digit permission code which you as the guardian will use to giver permission for your youth to participate in activities.
    <label>Permission Code (6 digits)
      <input type="text" id="permission_code" name="permission_code" pattern="\d{6}" required placeholder="123456">
    </label>

    <h3>Youth</h3>
    <div class="row">
      <div class="col">
        <label>First name <input type="text" id="y_first" required></label>
      </div>
      <div class="col">
        <label>Last name <input type="text" id="y_last" required></label>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Birth date <input type="date" id="y_birth"></label>
      </div>
      <div class="col">
        <label>Gender <input type="text" id="y_gender"></label>
      </div>
    </div>
    <label>Group
      <select id="y_group">
        <option value="">-- Select a group --</option>
        <option value="Deacons">Deacons</option>
        <option value="Teachers">Teachers</option>
        <option value="Priests">Priests</option>
        <option value="Younger Young Women">Younger Young Women</option>
        <option value="Older Young Women">Older Young Women</option>
      </select>
    </label>

    <h3>Parent / Guardian</h3>
    <label>Name <input type="text" id="pg_name" required></label>
    <div class="row">
      <div class="col"><label>Phone <input type="tel" id="pg_phone"></label></div>
      <div class="col"><label>Email <input type="email" id="pg_email"></label></div>
    </div>
    <label>Relationship <input type="text" id="pg_relationship"></label>

    <h3>Medical Info</h3>
    <label>Conditions <textarea id="m_conditions"></textarea></label>
    <label>Medications <textarea id="m_medications"></textarea></label>
    <label>Allergies <textarea id="m_allergies"></textarea></label>
    <label>Dietary restrictions <textarea id="m_diet"></textarea></label>
    <label>Limitations <textarea id="m_limits"></textarea></label>
    <label>Special accommodations <textarea id="m_accom"></textarea></label>

    <h3>Emergency Contact</h3>
    <label>Name <input type="text" id="e_name" required></label>
    <label>Phone <input type="tel" id="e_phone" required></label>

    <h3>Signature</h3>
    <label>Signed by (name) <input type="text" id="s_by" required></label>
    <div class="signature-box">
      <canvas id="sigCanvas" width="800" height="200"></canvas>
      <div style="margin-top:8px">
        <button type="button" id="clearSig" class="small">Clear</button>
        <button type="button" id="undoSig" class="small">Undo</button>
      </div>
    </div>

    <button type="submit">Submit</button>
    <div id="status"></div>
  </form>

<script>
(function(){
  // Get base URL from environment variable (window.BASE_URL) or localStorage, default to localhost:8000
  const BASE_URL = window.BASE_URL || localStorage.getItem('BASE_URL') || 'http://localhost:8000';
  
  const canvas = document.getElementById('sigCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let last = {x:0,y:0};
  const strokes = [];

  function resizeCanvas() {
    // keep drawing size consistent by using fixed backing size and CSS scaling
    canvas.style.width = '100%';
    canvas.style.height = '200px';
  }
  resizeCanvas();

  function pos(e){
    const rect = canvas.getBoundingClientRect();
    if (e.touches && e.touches.length) e = e.touches[0];
    return {x: (e.clientX-rect.left) * (canvas.width/rect.width), y: (e.clientY-rect.top) * (canvas.height/rect.height)};
  }

  function start(e){
    e.preventDefault();
    drawing = true;
    last = pos(e);
    strokes.push([last]);
  }
  function move(e){
    if(!drawing) return;
    e.preventDefault();
    const p = pos(e);
    strokes[strokes.length-1].push(p);
    drawStrokeSegment(last,p);
    last = p;
  }
  function end(e){
    drawing = false;
  }

  function drawAll(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    for(const s of strokes){
      if(s.length<1) continue;
      ctx.beginPath();
      ctx.moveTo(s[0].x, s[0].y);
      for(let i=1;i<s.length;i++) ctx.lineTo(s[i].x,s[i].y);
      ctx.stroke();
    }
  }
  function drawStrokeSegment(a,b){
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    ctx.beginPath();
    ctx.moveTo(a.x,a.y);
    ctx.lineTo(b.x,b.y);
    ctx.stroke();
  }

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('touchstart', start);
  window.addEventListener('mousemove', move);
  window.addEventListener('touchmove', move);
  window.addEventListener('mouseup', end);
  window.addEventListener('touchend', end);

  document.getElementById('clearSig').addEventListener('click', function(){
    strokes.length = 0; drawAll();
  });
  document.getElementById('undoSig').addEventListener('click', function(){
    strokes.pop(); drawAll();
  });

  const form = document.getElementById('permissionForm');
  const status = document.getElementById('status');

  form.addEventListener('submit', async function(ev){
    ev.preventDefault();
    status.textContent=''; status.className='';

    const permission_code = document.getElementById('permission_code').value.trim();
    if(!/^\d{6}$/.test(permission_code)){
      status.textContent = 'Permission code must be 6 digits.'; status.className='error'; return;
    }

    // render strokes to an offscreen canvas to produce a PNG data URL
    const outCanvas = document.createElement('canvas');
    outCanvas.width = canvas.width; outCanvas.height = canvas.height;
    const outCtx = outCanvas.getContext('2d');
    outCtx.fillStyle = '#fff'; outCtx.fillRect(0,0,outCanvas.width,outCanvas.height);
    outCtx.lineWidth = 2; outCtx.lineCap = 'round'; outCtx.strokeStyle = '#000';
    for(const s of strokes){
      if(!s.length) continue;
      outCtx.beginPath(); outCtx.moveTo(s[0].x,s[0].y);
      for(let i=1;i<s.length;i++) outCtx.lineTo(s[i].x,s[i].y);
      outCtx.stroke();
    }
    const dataUrl = outCanvas.toDataURL('image/png');

    const payload = {
      permission_code,
      youth: {
        first_name: document.getElementById('y_first').value.trim(),
        last_name: document.getElementById('y_last').value.trim(),
        birth_date: document.getElementById('y_birth').value || null,
        gender: document.getElementById('y_gender').value || null,
        group: document.getElementById('y_group').value || null
      },
      parent_guardian: {
        name: document.getElementById('pg_name').value.trim(),
        phone: document.getElementById('pg_phone').value.trim(),
        email: document.getElementById('pg_email').value.trim() || null,
        relationship: document.getElementById('pg_relationship').value || null
      },
      medical: {
        conditions: document.getElementById('m_conditions').value || null,
        medications: document.getElementById('m_medications').value || null,
        allergies: document.getElementById('m_allergies').value || null,
        dietary_restrictions: document.getElementById('m_diet').value || null,
        limitations: document.getElementById('m_limits').value || null,
        special_accommodations: document.getElementById('m_accom').value || null
      },
      emergency_contact: {
        name: document.getElementById('e_name').value.trim(),
        phone: document.getElementById('e_phone').value.trim()
      },
      signature: {
        signed_by: document.getElementById('s_by').value.trim(),
        signature_image_base64: dataUrl
      },
      signed_at: new Date().toISOString()
    };

    try{
      const res = await fetch(BASE_URL + '/users/', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(res.ok){
        status.textContent = 'Submitted successfully.'; status.className='success';
        form.reset(); strokes.length = 0; drawAll();
      }else{
        const text = await res.text();
        status.textContent = 'Error: '+res.status+ ' ' + text; status.className='error';
      }
    }catch(err){
      status.textContent = 'Network error: '+err.message; status.className='error';
    }
  });
})();
</script>
</body>
</html>
